# プロセスの排他制御について

## この文書について

* tateyama プロセスを起動する際に、多重起動が行われないように設定ファイルを保護するための仕組み

## 基本的な考え方

* tateyama プロセスを起動する際、同じ設定ファイルをもとに複数のプロセスが同時に起動しないようにする
  * 上記を検出するため、設定ファイルごとに `.pid` ファイルを生成し、 `.pid` ファイルが生成済みであればサービスの起動に失敗するようにする
  * クライアントが tateyama プロセスへ接続する際には、上記 `.pid` ファイルを確認し、ファイル内に記載された接続情報を利用する
  * `.pid` ファイルは一時ディレクトリ上に作成し、サービス終了時に削除する

## 設定項目

* `system` セクションの `pid_directory` に `.pid` ファイルを作成する一時ディレクトリを指定する

  ```ini
  [system]

  # path to create .pid files (default: $TMPDIR or /tmp)
  pid_directory = '/tmp'
  ```

  * 特別な理由がなければ、上記は既定の設定を利用する
* 注意点
  * 一時ディレクトリは、 tateyama プロセスから読み書き可能である必要がある
  * 一時ディレクトリは、 CLI を利用するユーザーから参照可能である必要がある

## .pid ファイルのパス

* 以下のパスに `.pid` ファイルを作成する

  ```txt
  <一時ディレクトリ>/tsurugi-<設定パスのダイジェスト値>.pid
  ```

  * パラメータ:
    * `<一時ディレクトリ>`
      * `system.pid_directory` の設定値
    * `<設定パスのダイジェスト値>`
      * 以下のように求める
        * 参照する設定ファイルのパスを `P` とおく
        * `P` の canonical な絶対パスを `P'` とおく
        * `P'` の区切り文字列を `/` に置き換えた文字列を `S` とおく
        * `S` の UTF-8 エンコードされたバイト列を `B` とおく
        * `B` の MD5 ハッシュ値を `H` とおく
        * `H` の各バイト値を `00` ~ `ff` の2桁の16進数表現 (小文字) で表したものが最終的な値となる
      * 例:
        * 入力: `/etc/tsurugidb/tsurugi.ini`
        * 出力: `ac4de01096e61ae241a287075a348b83`
